<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gauge Chart with Plotly.js</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #9E9C9B;
            flex-wrap: wrap;
        }
        .chart-container {
            margin: 5px;
            padding: 5px;
            background-color: #fff;
            border: 2px solid black;
        }
        .chart-container > div {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

<div class="chart-container">
    <div id="myDiv1"></div>
</div>

<div class="chart-container">
    <div id="myDiv2"></div>
</div>

<div class="chart-container">
    <div id="myDiv3"></div>
</div>

<script>
/** --- CONFIG LOADER --- **/
async function fetchConfig() {
    const response = await fetch("config.json");
    if (!response.ok) {
        throw new Error("Failed to load config.json");
    }
    return response.json();
}

/** --- GOOGLE SHEETS LOADER --- **/
function loadGoogleSheetData(apiKey, spreadsheetId) {
    const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';

    gapi.load('client:auth2', () => {
        gapi.client.init({
            apiKey: apiKey,
            discoveryDocs: DISCOVERY_DOCS,
            scope: SCOPES
        }).then(() => {
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: spreadsheetId,
                range: 'gauge_data1'
            }).then(response => {
                const range = response.result;
                if (range.values && range.values.length > 0) {
                    processData(range.values);
                } else {
                    console.log("No data found.");
                }
            }).catch(err => {
                console.error("Error fetching sheet data:", err);
            });
        });
    });
}

/** --- DATA PROCESSING + CHARTS --- **/
function processData(values) {
    const gaugeNames = [];
    const gaugeValues = [];
    const deltaValues = [];
    const currentValues = [];

    values.forEach(row => {
        const gaugeName = row[row.length - 1];
        const gaugeValue = parseFloat(row[1]);
        const deltaValue = parseFloat(row[2]);
        const currentValue = parseFloat(row[3]);

        if (!isNaN(gaugeValue) && !isNaN(deltaValue) && !isNaN(currentValue)) {
            gaugeNames.push(gaugeName);
            gaugeValues.push(gaugeValue);
            deltaValues.push(deltaValue);
            currentValues.push(currentValue);
        } else {
            console.log("Invalid data in row:", row);
        }
    });

    // Build 3 charts
    const data1 = createChartData(gaugeValues[0], deltaValues[0], currentValues[0], gaugeNames[0]);
    const data2 = createChartData(gaugeValues[1], deltaValues[1], currentValues[1], gaugeNames[1]);
    const data3 = createChartData(gaugeValues[2], deltaValues[2], currentValues[2], gaugeNames[2], true);

    const layout = {
        paper_bgcolor: "lightgray",
        width: 400,
        height: 300
    };

    Plotly.newPlot('myDiv1', data1, layout);
    Plotly.newPlot('myDiv2', data2, layout);
    Plotly.newPlot('myDiv3', data3, layout);
}

function createChartData(gaugeValue, deltaValue, currentValue, gaugeName, reversedColors = false) {
    const steps = [
        { range: [0, deltaValue], color: reversedColors ? "lightgreen" : "lightcoral" },
        { range: [deltaValue, gaugeValue], color: reversedColors ? "lightcoral" : "lightgreen" }
    ];

    return [{
        domain: { x: [0, 1], y: [0, 1] },
        value: currentValue,
        title: { text: gaugeName },
        type: "indicator",
        mode: "gauge+number+delta",
        delta: { reference: deltaValue },
        gauge: {
            axis: { range: [0, gaugeValue] },
            bar: { color: "darkblue" },
            steps: steps,
            threshold: {
                line: { color: "darkblue", width: 2 },
                value: deltaValue
            }
        }
    }];
}

/** --- APP ENTRYPOINT --- **/
window.onload = () => {
    fetchConfig()
        .then(({ apiKey, spreadsheetId }) => {
            console.log("Config loaded. API Key:", apiKey, "Sheet ID:", spreadsheetId);
            loadGoogleSheetData(apiKey, spreadsheetId);
        })
        .catch(error => {
            console.error("Error fetching configuration:", error);
        });
};
</script>

</body>
</html>
