<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Days Since Last Safety Incident</title>
<style>
    .text-size {
        font-size: 25px;
        color: black;
    }

    body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin-top: 50px;
        background-color: #9E9C9B
    }
    
    .date {
        display: block;
        width: 140px;
        margin: 30px auto;
        text-align: center;
        position: relative;
    }

    .date .binds {
        position: absolute;
        height: 15px;
        width: 105px;
        background: transparent;
        border: 2px solid #999;
        border-width: 0 5px;
        top: -6px;
        left: 0px;
        right: 0;
        margin: auto;
        border-radius: 5px; 
    }

    .date .month {
        background: linear-gradient(to right, #a92900 0%,#d73300 50%,#a92900 100%);
        display: block;
        padding: 8px 0;
        color: #fff;
        height: 14px;
        width:140px;
        font-weight: bold;
        border-bottom: 2px solid #333;
        box-shadow: inset 0 -1px 0 0 #666;
        border-radius: 20px 20px 0 0;
    }

    .date .day {
        display: block;
        margin: 0;
        padding: 10px 0;
        font-size: 85px;
        height: 110px;
        width: 140px;
        box-shadow: 0 0 3px #ccc;
        position: relative;
        border-radius: 0 0px 20px 20px;
        background: #d0d0d0;
        color: #444;
    }
</style>
</head>
<body>
    <p class="text-size"><b>Safety Record</b></p>
    <div class="date">
        <div class="month">Days</div>
        <div class="day" id="daysSinceIncident">0</div>
    </div>

    <p class="text-size"><b>Days Since Last Incident</b></p>

<script>
    // Calculate days between two dates
    function calculateDays(startDate, endDate) {
        const oneDay = 24 * 60 * 60 * 1000;
        const start = new Date(startDate);
        const end = new Date(endDate);
        return Math.round(Math.abs((end - start) / oneDay));
    }

    // Load config.json
    async function fetchConfig() {
        const response = await fetch("config.json");
        if (!response.ok) {
            throw new Error("Failed to load config.json");
        }
        return response.json();
    }

    // Fetch incident date from Google Sheets
    async function fetchIncidentDate(apiKey, spreadsheetId) {
        try {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Sheet1!A8?key=${apiKey}`;
            const response = await fetch(url);
            const data = await response.json();

            if (!data.values || !data.values[0] || !data.values[0][0]) {
                throw new Error("No incident date found in sheet");
            }

            const incidentDate = new Date(data.values[0][0]);
            const todayDate = new Date();
            const daysSinceIncident = calculateDays(incidentDate, todayDate);

            document.getElementById('daysSinceIncident').textContent = daysSinceIncident;
        } catch (error) {
            console.error("Error fetching incident date:", error);
        }
    }

    // Initialize
    async function init() {
        try {
            const { apiKey, spreadsheetId } = await fetchConfig();
            console.log("Config loaded:", apiKey, spreadsheetId);

            // First fetch
            fetchIncidentDate(apiKey, spreadsheetId);

            // Refresh every 15 minutes
            setInterval(() => fetchIncidentDate(apiKey, spreadsheetId), 900000);
        } catch (error) {
            console.error("Error initializing app:", error);
        }
    }

    // Start app
    window.onload = init;
</script>

<script src="refresh.js"></script>
</body>
</html>
